{% extends 'layouts/master.html' %}
{% block description %}
Back office du site
{% endblock %}
{% block keywords %}
dashboard, backoffice
{% endblock %}
{% block author%}TI-GENERATION{% endblock %}
{% block title %}ZoneAnimee | Login{% endblock %}

{% block content %}
<style>
    #alert-error-msg {
        color: #b70e1d !important;
    }

    #alert-success-msg {
        color: green !important;
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #000;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<!-- sign in -->
<div class="sign section--bg" data-bg="{{ url_for('static', path='/img/bg.jpg') }}">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="sign__content">
                    <!-- authorization form -->
                    <form class="sign__form">
                        <a href="/login" class="sign__logo" style="margin-bottom: 20px;">
                            <img src="{{ url_for('static', path='/img/logo.svg') }}" alt="">
                        </a>
                        
                        <div id="alert-error-msg" class="alert alert-danger mb-2" role="alert">
                            {% if error_message %}{{ error_message }}{% endif %}
                        </div>
                        
                        <div id="alert-success-msg" class="alert alert-danger mb-2" role="alert">
                            {% if success_message %}{{ success_message }}{% endif %}
                        </div>

                        <div class="sign__group">
                            <input id="username-email" type="text" class="sign__input" placeholder="Email or Username" required>
                            <span id="error-username" style="color: red"></span>
                        </div>

                        <div class="sign__group">
                            <input id="password" type="password" class="sign__input" placeholder="Password" required>
                            <span id="error-password" style="color: red"></span>
                        </div>

                        <div class="sign__group sign__group--checkbox">
                            <input id="remember" name="remember" type="checkbox" checked="checked">
                            <label for="remember">Remember me</label>
                        </div>
                        
                        <button class="sign__btn" type="button">Sign in</button>

                        <span class="sign__text"><a href="forgot.html">Forgot password?</a></span>
                    </form>
                    <!-- end authorization form -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end sign in -->


<script>
    function setCookie(name, value, seconds) {
        var expires = "";
        if (seconds) {
            var date = new Date();
            date.setTime(date.getTime() + (seconds * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    $('.sign__btn').on('click', function(event) {
        event.preventDefault();
    
        var usernameEmail = $('#username-email').val();
        var password = $('#password').val();
        var remember = $('#remember').is(':checked');
    
        $('.error-message').text('');
        $('#error-username').text('');
        $('#error-password').text('');
    
        if ((usernameEmail === '' || password === '')) {
            if (usernameEmail === '') {
                $('#error-username').text('Field Required');
            }
            if (password === '') {
                $('#error-password').text('Field Required');
            }
        } else {
            var formData = {
                grant_type: '',
                username: usernameEmail,
                password: password,
                scope: '',
                client_id: '',
                client_secret: ''
            };
            
            var encodedFormData = $.param(formData);
    
            $.ajax({
                url: 'http://127.0.0.1:8000/auth/token',
                method: 'POST',
                contentType: 'application/x-www-form-urlencoded',
                data: encodedFormData,
                beforeSend: function() {
                    $('.sign__btn').append('<div class="spinner"></div>');
                },
                complete: function() {
                    $('.spinner').remove();
                },
                success: function(data) {
                    $.ajax({
                        url: 'http://127.0.0.1:8000/users/me',
                        method: 'Get',
                        headers: {
                            'accept': 'application/json',
                            'Authorization': 'Bearer ' + data.access_token
                        },
                        success: function(item) {
                            console.log(item);
                            if(item.is_admin) {
                                setCookie("access_token", data.access_token, data.expires_in);
                                window.location.href = 'http://127.0.0.1:8002/'
                            } else {
                                $('#alert-error-msg').text('You are not authorized to access this interface.')
                            }
                        }
                    })
                },
                error: function(errors) {
                    $('.spinner').remove();
                    $('#alert-error-msg').text(errors.responseJSON.detail)
                }
            });
        }
    });
</script>
{% endblock %}